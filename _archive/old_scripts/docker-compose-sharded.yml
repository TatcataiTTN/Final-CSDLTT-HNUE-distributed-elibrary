version: '3.8'

# =============================================================================
# MongoDB SHARDED CLUSTER for Distributed e-Library System
# =============================================================================
#
# Architecture:
#   Config Servers (Replica Set "configReplSet"):
#     - configsvr1, configsvr2, configsvr3
#
#   Shard Servers:
#     - shard1 (port 27021): Shard for "Ha Noi" location data
#     - shard2 (port 27022): Shard for "Da Nang" location data
#     - shard3 (port 27023): Shard for "Ho Chi Minh" location data
#
#   Mongos Router:
#     - mongos (port 27017): Query router - applications connect here
#
# Sharding Strategy:
#   - Database: Nhasach (and branches)
#   - Collection: books
#   - Shard Key: { location: 1 } (range-based sharding by location)
#
# Usage:
#   1. Start cluster:     docker-compose -f docker-compose-sharded.yml up -d
#   2. Wait 30 seconds for services to initialize
#   3. Initialize:        ./init-sharding.sh
#   4. Verify:            docker exec -it mongos mongo --eval "sh.status()"
#   5. Stop:              docker-compose -f docker-compose-sharded.yml down
#   6. Clean all data:    docker-compose -f docker-compose-sharded.yml down -v
#
# =============================================================================

services:
  # ===========================================================================
  # CONFIG SERVERS (Replica Set for metadata storage)
  # ===========================================================================

  configsvr1:
    image: mongo:4.4
    container_name: configsvr1
    hostname: configsvr1
    ports:
      - "27101:27017"
    volumes:
      - configsvr1_data:/data/db
    networks:
      - shard-net
    command: ["mongod", "--configsvr", "--replSet", "configReplSet", "--bind_ip_all", "--port", "27017"]
    restart: unless-stopped

  configsvr2:
    image: mongo:4.4
    container_name: configsvr2
    hostname: configsvr2
    ports:
      - "27102:27017"
    volumes:
      - configsvr2_data:/data/db
    networks:
      - shard-net
    command: ["mongod", "--configsvr", "--replSet", "configReplSet", "--bind_ip_all", "--port", "27017"]
    restart: unless-stopped

  configsvr3:
    image: mongo:4.4
    container_name: configsvr3
    hostname: configsvr3
    ports:
      - "27103:27017"
    volumes:
      - configsvr3_data:/data/db
    networks:
      - shard-net
    command: ["mongod", "--configsvr", "--replSet", "configReplSet", "--bind_ip_all", "--port", "27017"]
    restart: unless-stopped

  # ===========================================================================
  # SHARD SERVERS (Data storage nodes)
  # ===========================================================================

  # Shard 1 - Ha Noi region data
  shard1:
    image: mongo:4.4
    container_name: shard1
    hostname: shard1
    ports:
      - "27021:27017"
    volumes:
      - shard1_data:/data/db
    networks:
      - shard-net
    command: ["mongod", "--shardsvr", "--replSet", "shard1ReplSet", "--bind_ip_all", "--port", "27017"]
    restart: unless-stopped

  # Shard 2 - Da Nang region data
  shard2:
    image: mongo:4.4
    container_name: shard2
    hostname: shard2
    ports:
      - "27022:27017"
    volumes:
      - shard2_data:/data/db
    networks:
      - shard-net
    command: ["mongod", "--shardsvr", "--replSet", "shard2ReplSet", "--bind_ip_all", "--port", "27017"]
    restart: unless-stopped

  # Shard 3 - Ho Chi Minh region data
  shard3:
    image: mongo:4.4
    container_name: shard3
    hostname: shard3
    ports:
      - "27023:27017"
    volumes:
      - shard3_data:/data/db
    networks:
      - shard-net
    command: ["mongod", "--shardsvr", "--replSet", "shard3ReplSet", "--bind_ip_all", "--port", "27017"]
    restart: unless-stopped

  # ===========================================================================
  # MONGOS ROUTER (Query router - applications connect here)
  # ===========================================================================

  mongos:
    image: mongo:4.4
    container_name: mongos
    hostname: mongos
    ports:
      - "27017:27017"
    networks:
      - shard-net
    command: ["mongos", "--configdb", "configReplSet/configsvr1:27017,configsvr2:27017,configsvr3:27017", "--bind_ip_all", "--port", "27017"]
    restart: unless-stopped
    depends_on:
      - configsvr1
      - configsvr2
      - configsvr3
      - shard1
      - shard2
      - shard3

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  shard-net:
    driver: bridge
    name: elibrary_shard_network

# =============================================================================
# VOLUMES (Persistent data storage)
# =============================================================================
volumes:
  configsvr1_data:
    name: elibrary_configsvr1_data
  configsvr2_data:
    name: elibrary_configsvr2_data
  configsvr3_data:
    name: elibrary_configsvr3_data
  shard1_data:
    name: elibrary_shard1_data
  shard2_data:
    name: elibrary_shard2_data
  shard3_data:
    name: elibrary_shard3_data
